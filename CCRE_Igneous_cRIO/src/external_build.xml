<?xml version="1.0" encoding="UTF-8"?>

<!--
/*
 * Copyright 2014 Colby Skeggs
 * 
 * This file is part of the CCRE, the Common Chicken Runtime Engine.
 * 
 * The CCRE is free software: you can redistribute it and/or modify it under the
 * terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 * 
 * The CCRE is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with the CCRE.  If not, see <http://www.gnu.org/licenses/>.
 */
 -->

<project name="CCRE Build">

	<!-- ccre-nonroot.dir and project.dir are set by the launch configuration, as generated by rebuild-builders.xml -->
	<property name="ccre-root.dir" location="${ccre-nonroot.dir}/.." />
	<property name="src.dir" value="${project.dir}/src" />
	<property name="build.dir" value="${project.dir}/build" />
	<property name="dist.dir" value="${project.dir}/dist" />

	<property file="${user.home}/wpilib/wpilib.properties" />
	<property file="${project.dir}/build.properties" />
	<property file="${user.home}/wpilib/java/${version}/ant/build.properties" />
	<property file="${src.dir}/main.properties" />

	<property name="emulate.jar" value="${dist.dir}/EmulationTarget.jar" />
	<property name="emulator.dir" value="${ccre-root.dir}/IgneousEmulator/bin" />
	<property name="classpath-new" value="${classpath}${path.separator}${ccre-root.dir}/CCRE_Igneous_RoboRIO/Igneous.jar" />

	<!-- Used iff wpilib 2015 is not installed. -->
	<property name="src.dir" value="src" />
	<property name="wpilib.ant.dir" value="ant_imposter" />

	<import file="${wpilib.ant.dir}/build.xml" />

	<target name="compile" description="Compile the source code.">
		<mkdir dir="${build.dir}" />
		<echo>[athena-compile] Compiling ${src.dir} with classpath=${classpath-new} to ${build.dir}</echo>

		<javac srcdir="${src.dir}" destdir="${build.dir}" includeAntRuntime="no" includeJavaRuntime="no" classpath="${classpath-new}" target="1.7" source="1.7" debug="true">
		</javac>
	</target>

	<target name="jar" depends="compile">
		<echo>[athena-jar] Making jar ${dist.jar}.</echo>
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${build.jars}" />

		<echo>[athena-jar] Copying jars from ${classpath-new} to ${build.jars}.</echo>
		<copy todir="${build.jars}" flatten="true">
			<path>
				<pathelement path="${classpath-new}" />
			</path>
		</copy>

		<jar destfile="${dist.jar}" update="false">
			<manifest>
				<attribute name="Main-Class" value="edu.wpi.first.wpilibj.RobotBase" />
				<attribute name="Robot-Class" value="ccre.igneous.RawIOIgneousLauncherImpl" />
				<attribute name="CCRE-Main" value="${igneous.main}" />
				<attribute name="Class-Path" value="." />
			</manifest>

			<fileset dir="${build.dir}" includes="**/*.class" />

			<zipgroupfileset dir="${build.jars}">
				<include name="**/*.jar" />
			</zipgroupfileset>
		</jar>

		<jar destfile="${emulate.jar}" update="false">
			<manifest>
				<attribute name="Igneous-Main" value="${igneous.main}" />
			</manifest>

			<fileset dir="${build.dir}" includes="**/*.class" />
		</jar>
	</target>

	<target name="emulate" depends="jar">
		<mkdir dir="${project.dir}/emulation-roborio" />
		<java jar="${ccre-root.dir}/IgneousEmulator/Emulator.jar" fork="true" dir="${project.dir}/emulation-roborio">
			<arg value="${emulate.jar}" />
			<classpath>
				<fileset dir="${emulator.dir}" includes="**/*.class" />
			</classpath>
		</java>
	</target>

	<import file="${ccre-root.dir}/CCRE_Igneous_cRIO/src/external_build_2014.xml" />

</project>
